<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Markers on Leaflet Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
	<div id="map" style="width:100vw;height:100vh"></div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            // Default data if no parameters provided
            let mapData = {
                tiles: "noLabelsLightTheme",
                geoinfo: [
                    { "USER": { "lat": 22, "lng": 114 } },
                    { "FOR_TEEN_ONLY": { "lat": 22, "lng": 114.01 } },
                    { "FOR_POOR_ONLY": { "lat": 22.0, "lng": 114.02 } },
                    { "FOR_ELDERLY_ONLY": { "lat": 22.0, "lng": 114.03 } },
                    { "FOR_ALL": { "lat": 22.0, "lng": 114.04 } },
                    { "CHECKPOINT": { "lat": 22.1, "lng": 114.0 } },
                    { "CHECKPOINT": { "lat": 22.1, "lng": 114.1 } },
                    { "CHECKPOINT": { "lat": 22.1, "lng": 114.2 } },
                    { "CHECKPOINT": { "lat": 22.1, "lng": 114.3 } },
                    { "CHECKPOINT": { "lat": 22.1, "lng": 114.4 } },
                    { "CHECKPOINT": { "lat": 22.2, "lng": 114.0 } },
                    { "CHECKPOINT": { "lat": 22.2, "lng": 114.1 } },
                    { "CHECKPOINT": { "lat": 22.2, "lng": 114.2 } },
                    { "CHECKPOINT": { "lat": 22.2, "lng": 114.3 } },
                    { "CHECKPOINT": { "lat": 22.2, "lng": 114.4 } },
                    { "CHECKPOINT": { "lat": 22.3, "lng": 114.0 } },
                    { "CHECKPOINT": { "lat": 22.3, "lng": 114.1 } },
                    { "CHECKPOINT_ACTIVE": { "lat": 22.3, "lng": 114.2 } },
                    { "CHECKPOINT": { "lat": 22.3, "lng": 114.3 } },
                    { "CHECKPOINT": { "lat": 22.3, "lng": 114.4 } },
                    { "CHECKPOINT": { "lat": 22.4, "lng": 114.0 } },
                    { "CHECKPOINT_ACTIVE": { "lat": 22.4, "lng": 114.1 } },
                    { "CHECKPOINT": { "lat": 22.4, "lng": 114.2 } },
                    { "CHECKPOINT": { "lat": 22.4, "lng": 114.3 } },
                    { "CHECKPOINT": { "lat": 22.4, "lng": 114.4 } }
                ]
            };
            // Override with URL data if provided
            if (dataParam) {
                try {
                    const parsedData = JSON.parse(decodeURIComponent(dataParam));
                    mapData = { ...mapData, ...parsedData };
                } catch (e) {
                    console.error("Error parsing URL data:", e);
                }
            }
            // Initialize map
            const map = L.map('map').setView([22.2, 114.2], 13);
            // Define tile layers
            const lightNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            });
            const standardTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });
            // Set initial tile layer based on parameter
            if (mapData.tiles === "noLabelsLightTheme") {
                lightNoLabels.addTo(map);
            } else {
                standardTiles.addTo(map);
            }
            // Create custom icons
            const icons = {
                USER: L.icon({
                    iconUrl: '圖庫/User.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                FOR_TEEN_ONLY: L.icon({
                    iconUrl: '圖庫/ForTeenOnly.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                FOR_POOR_ONLY: L.icon({
                    iconUrl: '圖庫/ForPoorOnly.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                FOR_ELDERLY_ONLY: L.icon({
                    iconUrl: '圖庫/ForElderlyOnly.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                FOR_ALL: L.icon({
                    iconUrl: '圖庫/ForAll.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                CHECKPOINT: L.icon({
                    iconUrl: '圖庫/Checkpoint.png',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                }),
                CHECKPOINT_ACTIVE: L.icon({
                    iconUrl: '圖庫/CheckpointAvailable.png',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                })
            };
			
			let markers = [];
			let bounds = L.latLngBounds();

			// Add markers to the map
			mapData.geoinfo.forEach(item => {
				const type = Object.keys(item)[0];
				const coords = item[type];
				const icon = icons[type] || icons.CHECKPOINT;
				const marker = L.marker([coords.lat, coords.lng], { icon: icon })
					.addTo(map)
					.bindPopup(`<b>${type.replace(/_/g, ' ')}</b><br>Latitude: ${coords.lat}<br>Longitude: ${coords.lng}`);
				markers.push(marker);
				bounds.extend(marker.getLatLng());
			});

			// Only fit bounds if we have markers
			if (markers.length > 0) {
				map.fitBounds(bounds);
			}
        });
    </script>
</body>
</html>
